services:
    mysql:
        image: mysql:8.0
        container_name: echo-mysql
        environment:
            MYSQL_ROOT_PASSWORD: your_root_password
            MYSQL_DATABASE: echo
            MYSQL_USER: your_db_user
            MYSQL_PASSWORD: your_db_password
        volumes:
            - mysql-data:/var/lib/mysql
            - ./db:/docker-entrypoint-initdb.d:ro
        ports:
            - "3306:3306"
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        restart: unless-stopped
        security_opt:
            - no-new-privileges:true
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 512M

    stun:
        image: instrumentisto/coturn
        container_name: echo-stun
        network_mode: host
        read_only: true
        depends_on:
            mysql:
                condition: service_healthy
        volumes:
            - ./stun.conf:/etc/turnserver.conf:ro
        command: -c /etc/turnserver.conf
        restart: unless-stopped
        security_opt:
            - no-new-privileges:true

    echo:
        build:
            context: .
            dockerfile: Dockerfile
            target: production
        container_name: echo-server
        depends_on:
            mysql:
                condition: service_healthy
            backend:
                condition: service_healthy
            stun:
                condition: service_started
        volumes:
            - ./echo.properties:/app/echo.properties:ro
            - ./assets:/app/assets:ro
        ports:
            - "5730-5740:5730-5740"
            - "5730-5740:5730-5740/udp"
        environment:
            JAVA_OPTS: "-Xmx512m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0"
            ECHO_ASSETS_DIR: /app/assets
        restart: unless-stopped
        security_opt:
            - no-new-privileges:true
        deploy:
            resources:
                limits:
                    memory: 768M
                reservations:
                    memory: 256M

    backend-api:
        build:
            context: ./backend
            dockerfile: Dockerfile
            target: production
        container_name: echo-backend
        depends_on:
            mysql:
                condition: service_healthy
        expose:
            - "80"
        environment:
            NODE_ENV: production
            DB_HOST: mysql
            DB_USER: your_db_user
            DB_PASSWORD: your_db_password
            DB_NAME: echo
            AUTH_KEY_HEX: ${AUTH_KEY_HEX}
        restart: unless-stopped
        read_only: true
        tmpfs:
            - /tmp:noexec,nosuid,size=64m
        security_opt:
            - no-new-privileges:true
        deploy:
            resources:
                limits:
                    memory: 256M
                reservations:
                    memory: 128M

volumes:
    mysql-data:
        driver: local
